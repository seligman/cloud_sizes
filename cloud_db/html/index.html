<html><head>
<!-- -----------------------------------------------------------------------------------------
This uses a database file generated by the utility that maintains the repo at
  https://github.com/seligman/cloud_sizes

If you'd like, there is a sample command line Python implementation of this at:
  https://github.com/seligman/seligman.github.io/blob/master/cloud-ips/lookup_ip_address.py

Some test IPs:
    AWS:    3.2.34.0
            2600:1ff2:4000::
    Google: 34.80.0.0
            2600:1900:4030::
    Azure:  40.126.0.0
            2a01:111:f403:f910::
    Private: 127.1.2.7
            ::1
------------------------------------------------------------------------------------------ -->
<title>Lookup Cloud IP</title>
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<style>
body {
    background:#272822;
    color:#f8f8f2;
    font-family:Menlo,Monaco,Consolas,monospace;
    font-size:12pt;
}
a {
    color:#a8a8f2;
    text-decoration:none;
}
a:hover{
    color:#a8a8f2;
    text-decoration:underline;
}
.note {
    font-size: 80%;
    color: #888;
}
input[type=button],input[type=submit],input[type=reset] {
    background-color: #444;
    border: none;
    color: #f8f8f2;
    padding: 2pt 20pt;
    text-decoration: none;
    cursor: pointer;
    font-family: Menlo,Monaco,Consolas,monospace;
    font-size: 12pt;
    -webkit-appearance: none;
}
input[type="text"],input[type="number"],textarea {
    background-color: #000;
    color: #cec;
    font-family: Menlo,Monaco,Consolas,monospace;
    font-size: 12pt;
    border-top-style: hidden;
    border-right-style: hidden;
    border-left-style: hidden;
    border-bottom-style: solid;
    border-bottom-width: 1px;
    border-bottom-color: #a8a8f2;
    padding: 2px;
}
input[type="text"],input[type="number"],textarea:focus {
    outline: none;
}
</style>
<script src="cidr_helper.min.js"></script>
<script>

async function getInfo() {
    var infoLoc = await readInt(25, 8);
    var info = (await decode(infoLoc))[0];
    return "Database last updated: " + info['built'];
}

var isLoading = false;
function loading(msg) {
    if (isLoading) {
        return false;
    }
    document.getElementById('results').innerHTML = msg;
    isLoading = true;
    return true;
}

document.addEventListener("DOMContentLoaded", function(event) {
    if (location.hash.startsWith("#")) {
        document.getElementById('ip').value = location.hash.substr(1);
    }
    document.getElementById('ip').oninput = function() {
        if (loading("Loading...")) {
            var val = document.getElementById('ip').value;
            lookup(val).then(result => {
                document.getElementById('results').innerHTML = result[0];
                if (result[1]) {
                    window.history.replaceState(null, null, "#" + val);
                } else {
                    window.history.replaceState(null, null, '#');
                }
                isLoading = false;
                if (document.getElementById('ip').value != val) {
                    document.getElementById('ip').oninput();
                }
            })
        }
    };
    loading("Initializing...");
    getInfo().then(info => {
        document.getElementById("lastUpdated").innerHTML = info;
        var val = document.getElementById('ip').value;
        isLoading = false;
        document.getElementById('ip').oninput();
    });
});

var chunks = [];
var allData = null;
async function read(offset) {
    if (allData !== null) {
        return allData[offset];
    }
    var chunkSize = 32768;
    var chunk = Math.floor(offset / chunkSize);
    if (chunks[chunk] === undefined) {
        var url = "cloud_db.dat";
        try {
            var resp = await fetch(
                url,
                {headers: {'range': 'bytes=' + (chunk * chunkSize) + '-' + ((chunk + 1) * chunkSize - 1)}}
            );
        } catch (e) {
            var resp = await fetch(url);
            var blob = await resp.blob();
            var buffer = await blob.arrayBuffer();
            allData = new Uint8Array(buffer);
            return allData[offset];
        }
        var blob = await resp.blob();
        var buffer = await blob.arrayBuffer();
        var temp = new Uint8Array(buffer);
        if (temp.length > chunkSize) {
            allData = temp;
            return allData[offset]
        }
        chunks[chunk] = temp;
    }
    return chunks[chunk][offset % chunkSize];
}

async function decode(offset) {
    if ((await read(offset) & 3) == 1) {
        var len = await read(offset) >> 2;
        offset++;
        var ret = {};
        for (var i = 0; i < len; i++) {
            var k, v, x;
            x = await decode(offset); k = x[0]; offset = x[1];
            x = await decode(offset); v = x[0]; offset = x[1];
            ret[k] = v;
        }
        return [ret, offset];
    } else if ((await read(offset) & 3) == 2) {
        var len = await read(offset) >> 2;
        offset++;
        var ret = [];
        for (var i = 0; i < len; i++) {
            var v, x;
            x = await decode(offset); v = x[0]; offset = x[1];
            ret.push(v);
        }
        return [ret, offset];
    } else {
        var len = await read(offset) >> 2;
        offset++;
        if (len == 63) {
            len = await readInt(offset, 2);
            offset += 2;
        }
        var v = '';
        for (x = 0; x < len; x += 1) {
            v += String.fromCharCode(await read(offset));
            offset++;
        }
        return [v, offset];
    }
}

async function readInt(offset, len) {
    var ret = 0;
    for (var x = 0; x < len; x++) {
        ret = (ret << 8) | await read(offset + x);
    }
    return ret;
}

async function lookup(ip) {
    ip = ip.trim();
    if (ip.length == 0) {
        return ["-", false];
    }

    try {
        ip = ipToBits(ip);
    } catch(e) {
        return ["(invalid IP)", false];
    }

    ip = (ip.length == 32 ? '0' : '1') + ip;

    var fieldSize = await readInt(23, 2);
    var infoLoc = await readInt(25, 8);
    var offset = 128 * 2;

    for (var i = 0; i < ip.length; i++) {
        if (ip[i] === "1") { offset += fieldSize * 2; }
        offset >>= 1;
        var val = 0;
        for (var x = 0; x < fieldSize; x++) {
            val = (val << 8) | await read(offset+x);
        }
        offset = val;
        if ((offset % 2) == 1) {
            break;
        }
    }

    offset >>= 1;
    var items = (await decode(offset))[0];

    if (items.length == 0) {
        return ["(unknown IP)", true];
    }

    var info = (await decode(infoLoc))[0];

    var ret = '';
    items.forEach(item => {
        var temp = cidrToIPs(item[3]);
        ret += "Prefix: " + item[3];
        if (temp[0] === temp[1]) {
            ret += " <i>(" + temp[0] + ")</i><br>";
        } else {
            ret += " <i>(" + temp[0] + " -&gt; " + temp[1] + ")</i><br>";
        }
        if (item[2].length > 0) {
            ret += "Region: " + item[2] + "<br>";
        }
        if (item[1].length > 0) {
            ret += "Service: " + item[1] + "<br>";
        }
        var source = item[0];
        if (source in info['sources']) {
            source = info['sources'][source];
        }
        ret += "Source: " + source + "<br>";
        ret += "<br>";
    });
    return [ret, true];
}
</script>
</head>
<body>
<p>Enter an IP to lookup which service it comes from:</p>
<input type="text" size="40" id="ip" autocomplete="off" autocorrect="off">
<br><br>
<div id="results"></div><br>
<div id="errors"></div>
<div id="lastUpdated" class="note"></div>
<hr>
Or, you can <a href="https://github.com/seligman/cloud_sizes/blob/master/cloud_db/lookup_ip_address.py">download a Python version of this tool</a>.
</body>
</html>
